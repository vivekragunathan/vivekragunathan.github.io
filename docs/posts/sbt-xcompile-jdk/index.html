<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xml:lang="en" lang="en" >

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="generator" content="Hugo 0.135.0">

	<title>Cross-JDK Compilation in SBT &middot; A Developer&#39;s Experience</title>

	<meta name="description" content="" />

	

	<link type="text/css" rel="stylesheet" href="/css/print.css" media="print">
	<link type="text/css" rel="stylesheet" href="/css/poole.css">
	<link type="text/css" rel="stylesheet" href="/css/hyde.css">

	
<style type="text/css">
  .sidebar {
    background-color: #347B98;
  }

  .read-more-link a {
    border-color: #347B98;
  }

  .pagination li a {
    color: #347B98;
    border: 1px solid #347B98;
  }

  .pagination li.active a {
    background-color: #347B98;
  }

  .pagination li a:hover {
    background-color: #347B98;
    opacity: 0.75;
  }

  footer a,
  .content a,
  .related-posts li a:hover {
    color: #347B98;
  }
</style>



	<link type="text/css" rel="stylesheet" href="/css/blockquote.css"><link type="text/css" rel="stylesheet" href="/css/custom.css">

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

	<link rel="stylesheet"
				href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
				integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
				crossorigin="anonymous" />

	<link rel="apple-touch-icon-precomposed"
				sizes="144x144"
				href="/images/apple-touch-icon-144-precomposed.png">

	<link rel="shortcut icon" href="/images/favicon.png">

	
	</head>

<body>
	<aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="/">
            <img 
              src="/images/profile.png" 
              class="img-circle img-headshot center" 
              alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>A Developer&#39;s Experience</h1>

      
      <p class="lead">The romantic image of an über-programmer is someone who fires up Emacs, types like a machine gun, and delivers a flawless final product from scratch. A more accurate image would be someone who stares quietly into space for a few minutes and then says Hmm. I think I’ve seen something like this before – John D. Cook</p>
      
    </div>

    <hr />

    <nav>
      <ul class="sidebar-nav">
        
        <li>
          <a href="/post/">Posts</a>
        </li><li>
          <a href="/pages">Pages</a>
        </li><li>
          <a href="/about/">About</a>
        </li><li>
          <a href="/quotations">Qs</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="https://stackoverflow.com/users/495612" rel="me" title="Stackoverflow" target="_blank">
        <i class="fab fa-stack-overflow" aria-hidden="true"></i>
      </a>
      
      <a href="https://github.com/vivekragunathan" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="https://twitter.com/higherkindedtpe" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>

    <section class="blog-search-section">
      <div class="blog-search-box">
	
	<button class="blog-search-btn"><i class="fas fa-search"></i></button>
	<input type="text" class="blog-search-input" placeholder="Type to Search...">

	<form style='display: none;' action='/search/' method="get">
		<input name="q" type="text">
	</form>
</div>
    </section>
  </div>
</aside>


	<main class="content container">
		<div class="post">
  
  <div class="image featured ">
  	
	</div>

  <h1>Cross-JDK Compilation in SBT</h1>


  <div class="post-date">
    <time datetime="2024-10-13T00:00:00Z">Oct 13, 2024</time> &middot; 4 min read
  </div>

  <p>Recently, I had to cross-compile a bunch of Scala library repositories for JDK 11 and JDK 17. I was hoping SBT would natively support specifying the related configuration in <code>build.sbt</code> similar to <code>crossScalaVersions</code>.  I came across some references to plugins that seemed to do the job. But I couldn&rsquo;t find anything in their documentation that  proved they supported compiling for different JDK versions. They only seemed<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> to provide better management and configuration options for cross compiling different Scala versions.</p>
<p>Unless there really exists a (better) way, let me show you what I went with. Just to be clear, SBT supports compiling for different JDK versions. It is not as fancy as you would think:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>sbt <span style="color:#ff79c6">-</span>java<span style="color:#ff79c6">-</span>home <span style="color:#ff79c6">&lt;</span>path<span style="color:#ff79c6">/</span>to<span style="color:#ff79c6">/</span>jdk11<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">package</span>
</span></span><span style="display:flex;"><span>sbt <span style="color:#ff79c6">-</span>java<span style="color:#ff79c6">-</span>home <span style="color:#ff79c6">&lt;</span>path<span style="color:#ff79c6">/</span>to<span style="color:#ff79c6">/</span>jdk17<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">package</span>
</span></span></code></pre></div><p>The caveat is you <em>have to</em> run the build more than once; like twice above. And that is what I <em>had to</em> go with. Well, the job doesn&rsquo;t end there. There are other things to take care of when cross compiling.</p>
<h2 id="conditional-compilation">Conditional Compilation</h2>
<p>If you have code that uses JDK version specific types or features, you would have to conditionally compile it based on the JDK version. Why conditional compilation? Because &hellip;</p>
<ul>
<li>Newer and richer features like <a href="https://openjdk.org/jeps/441">advanced</a> pattern matching or <a href="https://openjdk.org/jeps/430">string templates</a></li>
<li>Deprecated or removed packages and types such as <code>sun.security.x509</code>, <code>sun.misc.Unsafe</code> etc.</li>
</ul>
<p>In such cases, the awesome <a href="https://github.com/eed3si9n/ifdef">ifdef</a> plugin is your friend for conditional compilation. Here is how to set it up:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#6272a4">// Add this to plugins.sbt
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>addSbtPlugin<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;com.eed3si9n.ifdef&#34;</span> <span style="color:#ff79c6">%</span> <span style="color:#f1fa8c">&#34;sbt-ifdef&#34;</span> <span style="color:#ff79c6">%</span> <span style="color:#f1fa8c">&#34;0.3.0&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#6272a4">// Drop this in the `project/` folder
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">import</span> sbt._
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sbt.Keys._
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.eed3si9n.ifdef.sbtifdef._
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">JdkConditionalCompilationSetupPlugin</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">AutoPlugin</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> <span style="color:#ff79c6">requires:</span> <span style="color:#8be9fd">Plugin</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">IfDefPlugin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> trigger <span style="color:#ff79c6">=</span> allRequirements
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">object</span> <span style="color:#50fa7b">autoImport</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> jdkVersion <span style="color:#ff79c6">=</span> settingKey<span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">](</span><span style="color:#f1fa8c">&#34;JDK version&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> projectSettings<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Setting</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">]]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>    jdkVersion <span style="color:#ff79c6">:</span><span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;java.specification.version&#34;</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>    ifDefSettings <span style="color:#ff79c6">+=</span> <span style="color:#50fa7b">IfDefConf</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdk&#34;</span><span style="color:#ff79c6">,</span> jdkVersion<span style="color:#ff79c6">.</span>value<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>The above plugin is enabled automatically without having to add it explicitly to the <code>.enblePlugins</code> list.</p>
<p>With that, you have enabled JDK version based conditional compilation like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.eed3si9n.ifdef.<span style="color:#ff79c6">{</span>ifdef<span style="color:#ff79c6">,</span> ifndef<span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">TheBusinessLogicClass</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  @ifdef<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdk:11&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> legacyStyleImpl<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// JDK 11 specific implementation. Think a big
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// bloat of if-else based logic. Because we did
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// not have pattern matching back then.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  @ifdef<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdk:17&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> newerRicherImpl<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// JDK 17 specific implementation; using
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// pattern matching and other features!
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>Likewise, you can use <code>@ifndef(&quot;jdk:11&quot;)</code> annotation on methods that you want to exclude from compilation when not running on a certain JDK version (11 in this case).</p>
<blockquote>
<p>Highlight: <code>ifdef</code> also supports <code>&amp;</code> and <code>|</code> operators. e.g. <code>@ifdef(&quot;jdk:9 | jdk:11&quot;)</code></p>
</blockquote>
<h2 id="artifact-naming">Artifact Naming</h2>
<p>Here is the rub. While you are able to compile for different JDK versions, when you publish, the artifacts will be published to the same path, which means they will end up overwriting each other. Duh!</p>
<p>We have to differentiate the artifacts published either by its name or path. Also a visual confirmation, if you will, that you are dealing with the right artifact for a given JDK version.</p>
<p>Following are some options:</p>
<ul>
<li>Update <code>artifactName</code> setting to include the JDK version</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>artifactName <span style="color:#ff79c6">:</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">(</span>sv<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ScalaVersion</span><span style="color:#ff79c6">,</span> module<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ModuleID</span><span style="color:#ff79c6">,</span> artifact<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Artifact</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">val</span> jdkVersion <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;java.specification.version&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">s&#34;</span><span style="color:#f1fa8c">${</span>artifact<span style="color:#ff79c6">.</span>name<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-</span><span style="color:#f1fa8c">${</span>module<span style="color:#ff79c6">.</span>revision<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-jdk</span><span style="color:#f1fa8c">$jdkVersion</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">${</span>artifact<span style="color:#ff79c6">.</span>extension<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><ul>
<li>Publish to different paths (based on JDK version) in the Artifactory.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>publishTo <span style="color:#ff79c6">:</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">val</span> jdkVersion <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;java.specification.version&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;release repo&#34;</span> at <span style="color:#f1fa8c">s&#34;https://artifactory.mycompany.com/artifactory/&lt;repo-path&gt;/jdk</span><span style="color:#f1fa8c">$jdkVersion</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><ul>
<li>Include JDK version in your project or artifact version.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>version <span style="color:#ff79c6">:</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">val</span> jdkVersion <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;java.specification.version&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f1fa8c">s&#34;1.2.3-</span><span style="color:#f1fa8c">$jdkVersion</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>There is no absolute winner. The choice depends on the factors such as team standards, operational and company policies etc. The simplest of them all - using JDK version in project version, may not be appealing because it does not follow semantic versioning; if you wish to stick to that.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>If my understanding of those plugins is not right or if there is some plugin that offers cross compiling for different JDKs, I would love to know.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</div>


	</main>

	<footer>
  <div>
    &copy;  2024

    

    
  </div>
</footer>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
					integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
					crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@400;700&display=swap" />









	<script src="https://unpkg.com/lunr@2.3.9/lunr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="/js/search.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	

	<script>
	window.store = {
	  
	  
	}

	hljs.highlightAll();

	document
		.querySelector('.blog-search-input')
		.addEventListener('keyup', function (event) {
			event.preventDefault();

			if (event.keyCode === 13) {
				document.querySelector('.blog-search-box>form>input').value = 
					document.querySelector('.blog-search-input').value;

				document
					.querySelector('.blog-search-box>form')
					.submit(
);
			}
		});
	</script>

	
</body>

</html>
